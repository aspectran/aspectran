<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE aspectran PUBLIC "-//ASPECTRAN//DTD Aspectran 9.0//EN"
        "https://aspectran.com/dtd/aspectran-9.dtd">
<aspectran>

    <description>
        Aspectran configuration for setting up the servlet context.
    </description>

    <environment>
        <property name="tow.context.root.name">root</property>
    </environment>

    <bean id="tow.context.root.servletContext"
          class="com.aspectran.undertow.server.servlet.TowServletContext"
          scope="prototype">
        <property name="deploymentName">%{tow.context.root.name}</property>
        <property name="contextPath">/</property>
        <property name="resourceManager">
            <bean class="com.aspectran.undertow.server.handler.resource.TowResourceManager">
                <property name="base">/webapps/%{tow.context.root.name}</property>
            </bean>
        </property>
        <property name="scratchDir">/work/_webapps/%{tow.context.root.name}</property>
        <property name="sessionManager">#{tow.context.root.sessionManager}</property>
        <property name="servletSessionConfig">
            <bean class="io.undertow.servlet.api.ServletSessionConfig">
                <!-- Disable URL-based session tracking (no more 'jsessionid' in the URL) -->
                <property name="sessionTrackingModes" type="set">
                    <value>#{class:jakarta.servlet.SessionTrackingMode^COOKIE}</value>
                </property>
                <property name="path" value="/"/>
            </bean>
        </property>
        <property name="servlets" type="array">
            <bean class="com.aspectran.undertow.server.servlet.DefaultJspServlet">
                <property name="loadOnStartup" valueType="int">0</property>
            </bean>
            <bean class="com.aspectran.undertow.server.servlet.TowServlet">
                <argument>webActivityServlet</argument>
                <argument>com.aspectran.web.servlet.WebActivityServlet</argument>
                <property name="mappings" type="array">
                    <value>/</value>
                </property>
                <property name="loadOnStartup" valueType="int">1</property>
                <property name="asyncSupported" valueType="boolean">true</property>
            </bean>
        </property>
        <property name="servletContainerInitializers" type="array">
            <bean class="com.aspectran.undertow.server.servlet.TowJasperInitializer">
                <property name="tldResources" type="array">
                    <value>classpath:com/aspectran/web/support/tags/aspectran.tld</value>
                    <value>/webapps/%{tow.context.root.name}/WEB-INF/taglibs/</value>
                </property>
            </bean>
        </property>
        <property name="webSocketServerContainerInitializer">
            <bean class="com.aspectran.undertow.server.servlet.TowWebSocketServerContainerInitializer">
                <property name="directBuffers" valueType="boolean">false</property>
                <property name="bufferSize" valueType="int">1024</property>
            </bean>
        </property>
    </bean>

    <bean id="tow.context.root.sessionManager"
          class="com.aspectran.undertow.server.session.TowSessionManager"
          scope="prototype">
        <property name="sessionManagerConfig">
            <bean class="com.aspectran.core.context.config.SessionManagerConfig">
                <argument>
                    workerName: n0
                    maxActiveSessions: 99
                    maxIdleSeconds: 600
                    evictionIdleSeconds: 300
                    scavengingIntervalSeconds: 180
                    clusterEnabled: false
                </argument>
            </bean>
        </property>
        <properties profile="(!rss-lettuce, !rss-lettuce-primaryreplica, !rss-lettuce-cluster)">
            <item name="sessionStore">
                <bean class="com.aspectran.core.component.session.FileSessionStoreFactoryBean">
                    <properties>
                        <item name="storeDir">/work/_sessions/tow</item>
                    </properties>
                </bean>
            </item>
        </properties>
        <properties profile="rss-lettuce">
            <item name="sessionStore">
                <bean class="com.aspectran.core.component.session.redis.lettuce.DefaultLettuceSessionStoreFactoryBean">
                    <properties>
                        <item name="poolConfig">
                            <bean class="com.aspectran.core.component.session.redis.lettuce.RedisConnectionPoolConfig">
                                <properties>
                                    <item name="uri">redis://localhost:6379/0</item>
                                </properties>
                            </bean>
                        </item>
                    </properties>
                </bean>
            </item>
        </properties>
        <properties profile="rss-lettuce-primaryreplica">
            <item name="sessionStore">
                <bean class="com.aspectran.core.component.session.redis.lettuce.DefaultLettuceSessionStoreFactoryBean">
                    <properties>
                        <item name="poolConfig">
                            <bean class="com.aspectran.core.component.session.redis.lettuce.RedisConnectionPoolConfig">
                                <properties>
                                    <item name="uri">redis-sentinel://localhost:11001,localhost:11002,localhost:11003?sentinelMasterId=mymaster</item>
                                </properties>
                            </bean>
                        </item>
                    </properties>
                </bean>
            </item>
        </properties>
        <properties profile="rss-lettuce-cluster">
            <item name="sessionStore">
                <bean class="com.aspectran.core.component.session.redis.lettuce.cluster.ClusterLettuceSessionStoreFactoryBean">
                    <properties>
                        <item name="poolConfig">
                            <bean class="com.aspectran.core.component.session.redis.lettuce.cluster.RedisClusterConnectionPoolConfig">
                                <properties>
                                    <item name="uri">redis://127.0.0.1:6379,127.0.0.1:6380,127.0.0.1:6381</item>
                                </properties>
                            </bean>
                        </item>
                    </properties>
                </bean>
            </item>
        </properties>
    </bean>

</aspectran>
